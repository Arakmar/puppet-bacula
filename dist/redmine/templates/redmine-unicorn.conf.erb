NameVirtualHost <%= ipaddress %>:<%= port %>
<VirtualHost <%= ipaddress %>:<%= port %>>
  ServerName projects.reductivelabs.com
<% if ssl == true %>
  Redirect / https://projects.puppetlabs.com/
  SSLEngine on
  SSLCertificateFile /etc/ssl/certs/pl.cert
  SSLCertificateKeyFile /etc/ssl/private/pl.key
<% else %>
  Redirect / http://projects.puppetlabs.com/
<% end %>
</VirtualHost>

<VirtualHost <%= ipaddress %>:<%= port %>>
  #ServerName <%= name %>
  ServerName projects.puppetlabs.com
  DocumentRoot <%= docroot %>

	RewriteEngine On
	RewriteCond %{HTTPS} !=on
	#RewriteRule ^/login$ https://%{SERVER_NAME}/login [R,L]
  RewriteRule ^/login(.*)$ https://%{SERVER_NAME}/login$1 [R,L]

	RewriteCond %{HTTPS} !=on
	RewriteRule ^/account/register$ https://%{SERVER_NAME}/account/register [R,L]

<% if ssl == true %>
  RequestHeader set X_FORWARDED_PROTO 'https'
  SSLEngine on
  SSLCertificateFile /etc/ssl/certs/pl.cert
  SSLCertificateKeyFile /etc/ssl/private/pl.key
<% end %>

  ProxyRequests Off
   
  <Proxy *>
     Order deny,allow
     Allow from all
  </Proxy>
   
  ProxyPass / http://localhost:8080/
  ProxyPassReverse / http://localhost:8080/

  # Custom log file locations
  ErrorLog  /var/log/apache2/<%= name %>_error.log
  CustomLog /var/log/apache2/<%= name %>_access.log combined

</VirtualHost>
