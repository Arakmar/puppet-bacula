NameVirtualHost <%= ipaddress %>:<%= port %>
<VirtualHost <%= ipaddress %>:<%= port %>>
  ServerName <%=srvname%>
  DocumentRoot <%= docroot %>

  # Support SSL Redirection for authentication
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^/login(.*)$ https://%{SERVER_NAME}/login$1 [R,L]

  RewriteCond %{HTTPS} !=on
  RewriteRule ^/account/register$ https://%{SERVER_NAME}/account/register [R,L]
<% if ssl == true %>
  RequestHeader set X_FORWARDED_PROTO 'https'
  SSLEngine on
  SSLCertificateFile /etc/ssl/certs/pl.cert
  SSLCertificateKeyFile /etc/ssl/private/pl.key
<% end %>
  ProxyRequests Off

  <Proxy *>
     Order deny,allow
     Allow from all
  </Proxy>

  # This is a big ugly hardcoded section. So thus rendering it pointless in many
  # ways to manage so freely with puppet as we are. But what can you do?
  # See/? http://httpd.apache.org/docs/2.2/mod/mod_proxy.html#proxypass for why.
  ProxyPass /projects/puppet/wiki/Exported_Resources !
  RedirectMatch permanent	/projects/puppet/wiki/Exported_Resources?                 http://docs.puppetlabs.com/guides/exported_resources.html
  ProxyPass /projects/puppet/wiki/External_Nodes !
  RedirectMatch permanent	/projects/puppet/wiki/External_Nodes/?                    http://docs.puppetlabs.com/guides/external_nodes.html
  ProxyPass /projects/puppet/wiki/Frequently_Asked_Questions !
  RedirectMatch permanent	/projects/puppet/wiki/Frequently_Asked_Questions/?        http://docs.puppetlabs.com/guides/faq.html
  ProxyPass /projects/puppet/wiki/Plugins_In_Modules !
  RedirectMatch permanent	/projects/puppet/wiki/Plugins_In_Modules/?                http://docs.puppetlabs.com/guides/plugins_in_modules.html
  ProxyPass /projects/puppet/wiki/Development_Creating_Custom_Types !
  RedirectMatch permanent	/projects/puppet/wiki/Development_Creating_Custom_Types/? http://docs.puppetlabs.com/guides/custom_types.html
  ProxyPass /projects/puppet/wiki/Puppet_Executables !
  RedirectMatch permanent	/projects/puppet/wiki/Puppet_Executables/?                http://docs.puppetlabs.com/guides/tools.html
  ProxyPass /projects/puppet/wiki/Module_Organisation !
  RedirectMatch permanent	/projects/puppet/wiki/Module_Organisation/?               http://docs.puppetlabs.com/guides/modules.html
  ProxyPass /projects/puppet/wiki/Language_Tutorial !
  RedirectMatch permanent	/projects/puppet/wiki/Language_Tutorial/?                 http://docs.puppetlabs.com/guides/language_guide.html
  ProxyPass /projects/puppet/wiki/Getting_Started !
  RedirectMatch permanent	/projects/puppet/wiki/Getting_Started/?                   http://docs.puppetlabs.com/#getting_started
  ProxyPass /projects/puppet/wiki/Style_Guide !
  RedirectMatch permanent	/projects/puppet/wiki/Style_Guide/?                       http://docs.puppetlabs.com/guides/style_guide
  ProxyPass /projects/puppet/wiki/Puppet_Templating !
  RedirectMatch permanent /projects/puppet/wiki/Puppet_Templating                   http://docs.puppetlabs.com/guides/templating.html
  ProxyPass /projects/puppet/wiki/Puppet_Internals !
  RedirectMatch permanent /projects/puppet/wiki/Puppet_Internals                    http://docs.puppetlabs.com/guides/puppet_internals.html
  ProxyPass /projects/puppet/wiki/Virtual_Resources !
  RedirectMatch permanent /projects/puppet/wiki/Virtual_Resources                   http://docs.puppetlabs.com/guides/virtual_resources.html
  ProxyPass /projects/puppet/wiki/Using_Multiple_Environments !
  RedirectMatch permanent /projects/puppet/wiki/Using_Multiple_Environments         http://docs.puppetlabs.com/guides/environment.html

  ProxyPass /projects/1/wiki/Exported_Resources !
  RedirectMatch permanent	/projects/1/wiki/Exported_Resources?                 http://docs.puppetlabs.com/guides/exported_resources.html
  ProxyPass /projects/1/wiki/External_Nodes !
  RedirectMatch permanent	/projects/1/wiki/External_Nodes/?                    http://docs.puppetlabs.com/guides/external_nodes.html
  ProxyPass /projects/1/wiki/Frequently_Asked_Questions !
  RedirectMatch permanent	/projects/1/wiki/Frequently_Asked_Questions/?        http://docs.puppetlabs.com/guides/faq.html
  ProxyPass /projects/1/wiki/Plugins_In_Modules !
  RedirectMatch permanent	/projects/1/wiki/Plugins_In_Modules/?                http://docs.puppetlabs.com/guides/plugins_in_modules.html
  ProxyPass /projects/1/wiki/Development_Creating_Custom_Types !
  RedirectMatch permanent	/projects/1/wiki/Development_Creating_Custom_Types/? http://docs.puppetlabs.com/guides/custom_types.html
  ProxyPass /projects/1/wiki/Puppet_Executables !
  RedirectMatch permanent	/projects/1/wiki/Puppet_Executables/?                http://docs.puppetlabs.com/guides/tools.html
  ProxyPass /projects/1/wiki/Module_Organisation !
  RedirectMatch permanent	/projects/1/wiki/Module_Organisation/?               http://docs.puppetlabs.com/guides/modules.html
  ProxyPass /projects/1/wiki/Language_Tutorial !
  RedirectMatch permanent	/projects/1/wiki/Language_Tutorial/?                 http://docs.puppetlabs.com/guides/language_guide.html
  ProxyPass /projects/1/wiki/Getting_Started !
  RedirectMatch permanent	/projects/1/wiki/Getting_Started/?                   http://docs.puppetlabs.com/#getting_started
  ProxyPass /projects/1/wiki/Style_Guide !
  RedirectMatch permanent	/projects/1/wiki/Style_Guide/?                       http://docs.puppetlabs.com/guides/style_guide
  ProxyPass /projects/1/wiki/Puppet_Templating !
  RedirectMatch permanent /projects/1/wiki/Puppet_Templating                   http://docs.puppetlabs.com/guides/templating.html
  ProxyPass /projects/1/wiki/Puppet_Internals !
  RedirectMatch permanent /projects/1/wiki/Puppet_Internals                    http://docs.puppetlabs.com/guides/puppet_internals.html
  ProxyPass /projects/1/wiki/Virtual_Resources !
  RedirectMatch permanent /projects/1/wiki/Virtual_Resources                   http://docs.puppetlabs.com/guides/virtual_resources.html
  ProxyPass /projects/1/wiki/Using_Multiple_Environments !
  RedirectMatch permanent /projects/1/wiki/Using_Multiple_Environments         http://docs.puppetlabs.com/guides/environment.html

  # Now anything that is left, lets proxy this to localhost.
  ProxyPass / http://localhost:8080/
  ProxyPassReverse / http://localhost:8080/

  # Custom log file locations
  ErrorLog  /var/log/apache2/<%= name %>_error.log
  CustomLog /var/log/apache2/<%= name %>_access.log combined

</VirtualHost>
