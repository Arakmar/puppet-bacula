#!/bin/bash

. ~interch/etc/server-list.sh

today=`date +'%a %b %e'`
count=0
ssh_opt='-axqT -o BatchMode=yes -i /root/.ssh/id_dsa.bcs-push-robot-root'

echo "500 Errors so far $today"
echo
echo -e "Server\t\tCount\tLast Error"

for x in $servers
do
	server_count=`ssh $ssh_opt $x "grep -sc '* Time: $today' /tmp/error500.log"`
	[ -z "$server_count" ] && continue
	server_ts=`ssh $ssh_opt $x 'ls -l /tmp/error500.log' 2>/dev/null | perl -pe 's/^.*([A-Z][a-z][a-z]\s+\d\d?\s+\d\d:\d\d)\s+.*/$1/g'`
	echo -n -e "$x\t"
	if [ ${#x} -lt 8 ]; then
		echo -n -e "\t"
	fi
	printf '%5u' $server_count
	echo -e "\t$server_ts"
	count=$(( $count + $server_count ))
done

echo
echo -e "Total for $today:\t$count"
