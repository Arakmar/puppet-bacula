#!/bin/sh


serveruser=`echo $1 | cut -d '@' -f 1`
server=`echo $1 | cut -d '@' -f 2`

if [ "$server" == "" ]; then
    echo "Usage: $0 serveruser\@server key_username"
    exit 1
fi

username="$2"
if [ "$username" == "" ]; then
    echo "Usage: $0 [server] [username]"
    exit 1
fi

key_tmpfile="/tmp/key_tmpfile.$$"

user_key=`grep $username .ssh/authorized_keys`
if [ "$user_key" == "" ]; then
    echo "No key found for user $username!"
    exit 1
fi

key_count=`echo $user_key | wc -l`
if [ "$key_count" != "1" ]; then
    echo "More than one key found for $username.  Please look into it."
    exit 2
fi

echo "Sending ssh key for $username to $serveruser@$server..."
num_entries=`ssh $serveruser@$server "grep $username .ssh/authorized_keys | wc -l"`
echo "Removing $num_entries old entries first from $serveruser@$server:~/.ssh/authorized_keys"
ssh $serveruser@$server "grep -v $username .ssh/authorized_keys > .ssh/authorized_keys.new; mv .ssh/authorized_keys.new .ssh/authorized_keys"
echo $user_key | ssh $serveruser@$server 'cat >> .ssh/authorized_keys'

echo "done"

