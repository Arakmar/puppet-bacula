#!/bin/sh

# This script expects a list of servernames from the commandline

trap "exit 1" INT

. ~interch/etc/server-list.sh

sshkey='/root/.ssh/id_dsa.bcs-push-robot-root'

servers_to_clear=

# If a list of servers are given from the command line
# then use those, else use all webapps.
if [ "$1" == "" ]; then
    servers_to_clear=$servers
else
    servers_to_clear=$*
fi


for i in $servers_to_clear
do
    echo $i

    ssh -i $sshkey $i 'service mvc_cached stop'
    ssh -i $sshkey $i 'rm -f /var/lib/interchange/bin/mvc_cached_run/mvc_cached.pid'
    pids=`ssh -i $sshkey $i 'ps auwwwx | grep mvc_cached | grep -v grep' | awk '{ print $2 }'`
    echo $pids
    for p in $pids
    do
        echo "Killing pid $p"
        ssh -i $sshkey $i "kill -9 $p"
    done
    ssh -i $sshkey $i 'service mvc_cached start'
done
