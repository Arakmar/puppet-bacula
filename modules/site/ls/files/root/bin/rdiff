#!/usr/local/bin/perl

use strict;
use warnings;


# Get arguments
my ($first, $second) = @ARGV;

if (!$first || !$second) {
    die "Missing files to diff!";
}

# Don't buffer output
$| = 1;

# Store temp files to be cleaned up later
my @tmp_files;

# Get the first file
my $first_file;
if ($first =~ /:/) {
    my ($server, $file) = split /:/, $first;

    $first_file = "$server-$file.tmp$$-1";
    $first_file =~ s/[^\w\-\.\d]/_/g;
    $first_file = "/tmp/$first_file";
    my $cmd = "scp -p $first $first_file";
    my $rv = `$cmd`;
    print $rv, $/;
    push @tmp_files, $first_file;
}
else {
    if (! -f $first) {
        die "File not found: $first!";
    }
    $first_file = $first;
}


# Get the second file
my $second_file;
if ($second =~ /:/) {
    my ($server, $file) = split /:/, $second;

    $second_file = "$server-$file.tmp$$-2";
    $second_file =~ s/[^\w\-\.\d]/_/g;
    $second_file = "/tmp/$second_file";
    my $cmd = "scp -p $second $second_file";
    my $rv = `$cmd`;
    print $rv, $/;
    push @tmp_files, $second_file;
}
else {
    if (! -f $second) {
        die "File not found: $second!";
    }
    $second_file = $second;
}

# Diff the two files
my $diff = `diff -u $first_file $second_file`;
print $diff, $/;


# Clean up any tmp files generated
END {
   -f $_ && unlink($_)  foreach (@tmp_files);
}


