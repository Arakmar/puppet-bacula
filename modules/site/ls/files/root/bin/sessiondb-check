#!/usr/local/bin/perl

use strict;
use warnings;


# Ping the existing sessiondb
#my $ping_out = `ping -c 2 sessiondb`;

# If everything is find, then nothing to do so exit
#exit  unless ($ping_out =~ /Destination Host Unreachable/);

print "Could not ping sessiondb!!!\n";
print "Switching sessiondb servers!!!\n";

# Load up /etc/hosts
my $etc_hosts_file = '/tmp/hosts';
open my $hosts_fh, '<', $etc_hosts_file or die "Cannot open $etc_hosts_file: $!";
my $etc_hosts = do { local $/; <$hosts_fh>; };
close $hosts_fh;

# Set our two sessiondb servers
my ($primary, $secondary) = ('tahoe', 'telluride');

# Get the IP addresses for each
my ($primary_ip) = $etc_hosts =~ /^([\d\.]+)\s+$primary\b/m;
my ($secondary_ip) = $etc_hosts =~ /^([\d\.]+)\s+$secondary\b/m;

print "primary_ip=$primary_ip, secondary_ip=$secondary_ip\n";

# Find out which one we are currently on
my ($current_sessiondb_ip) = $etc_hosts =~ /^([\d\.]+)\s+sessiondb\b/m;
my ($current_sessiondb) = $etc_hosts =~ /^$current_sessiondb_ip\s+([\w\.]+)/m;

# Get the new IP to switch to
my $new_sessiondb_ip = ($current_sessiondb_ip eq $primary_ip) ? $secondary_ip : $primary_ip;

print "current_db=$current_sessiondb, current_ip=$current_sessiondb_ip, new_ip=$new_sessiondb_ip\n";

# Ping the new sessindb to check it is ok
my $ping_new_sessiondb = `ping -c 2 $new_sessiondb_ip`;
if ($ping_new_sessiondb =~ /Destination Host Unreachable/) {
    my $message = qq{
Could not reach either session db.  Currently listed in /etc/hosts on standby:
Current sessiondb: $current_sessiondb $current_sessiondb_ip

Primary: $primary $primary_ip
Secondary:$secondary $secondary_ip
    };
    file_p5_bug({title   => 'Sessiondb is DOWN (both primary and secondary sessiondbs are unreachable)',
                 message => $message,
                });
    exit;
}


# Update our copy of /etc/hosts with the change
$etc_hosts =~ s/^$current_sessiondb_ip(\s+sessiondb2?\b.*)$/$new_sessiondb_ip$1/mg;

# Make a backup of the hosts file
system('cp', $etc_hosts_file, "$etc_hosts_file.bak");

# Save the changes to file
open my $new_hosts_fh, '>', "$etc_hosts_file" or die "Cannot write $etc_hosts_file: $!";
print $new_hosts_fh $etc_hosts;
close $new_hosts_fh;



#--------------------------
sub file_p5_bug {
    my $arg = shift;
    print "Filing p5 bug: ", $arg->{title}, "\n";
    print $arg->{message}, "\n";
    return;
}


