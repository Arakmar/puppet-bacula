#!/usr/local/bin/perl

use strict;
use warnings;
use DBI;

my $base = '/var/lib/pgsql/data/base';
my $backups = '/var/lib/pgsql/backups';

my $dbh = DBI->connect('dbi:Pg:dbname=template1', 'postgres');
my $sth = $dbh->prepare(<<'EOQ');
SELECT datid, datname
FROM pg_stat_database
EOQ
$sth->execute;
my %id2name;
while (my $row = $sth->fetchrow_hashref) {
	$id2name{$row->{datid}} = $row->{datname};
}
$sth->finish;
$dbh->disconnect;

print "Database (Kilobytes on disk)\n";
opendir PG, $base or die "Can't open PostgreSQL database directory: $!\n";
for my $dir (sort readdir(PG)) {
	next if $dir =~ /^\./ or $id2name{$dir} =~ /^template\d+$/;
	my $size = `du -ks $base/$dir`;
	$size =~ s/^\s+//;
	$size =~ s/\D.*$//s;
	print "$id2name{$dir} ($size)\n";
}
closedir PG;

purty_ls($backups);

purty_ls('/var/log/pgsql');

print "\n", `df -hT`;


sub purty_ls {
	my ($dir) = @_;
	local @_ = `ls -lFa $dir`;
	shift if $_[0] =~ /^total\s+\d+$/;
	print "\n$dir\n", @_;
	return;
}

