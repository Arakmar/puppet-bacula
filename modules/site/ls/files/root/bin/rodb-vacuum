#!/bin/sh

# Get the server from the command line
server="$1"
if [ "$server" == "" ]; then
   echo Usage: $0 server_name
   exit 1
fi

sshkey=/root/.ssh/id_dsa.bcs-push-robot-root

# Vacuum, and reindex bcs database on this read-only server
psql_cmd="SET statement_timeout=0; INSERT INTO infra.server_busy (reason) VALUES ('work'); VACUUM FULL; REINDEX DATABASE bcs; ANALYZE; DELETE FROM infra.server_busy WHERE reason = 'work';"
echo "$server - `date`"
echo `ssh -a -i $sshkey $server 'du -hs /var/lib/pgsql/data/'`
echo Running $psql_cmd
echo `echo $psql_cmd | ssh -a -i $sshkey $server 'psql -U bcs bcs'`
echo `ssh -a -i $sshkey $server 'du -hs /var/lib/pgsql/data/'`
echo "Done. `date`"

