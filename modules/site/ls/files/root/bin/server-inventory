#!/bin/sh

#	# regular colors
#   K="\[\033[0;30m\]"    # black
#   R="\[\033[0;31m\]"    # red
#   G="\[\033[0;32m\]"    # green
#   Y="\[\033[0;33m\]"    # yellow
#   B="\[\033[0;34m\]"    # blue
#   M="\[\033[0;35m\]"    # magenta
#   C="\[\033[0;36m\]"    # cyan
#   W="\[\033[0;37m\]"    # white
#   
#   # empahsized (bolded) colors
#   EMK="\[\033[1;30m\]"
#   EMR="\[\033[1;31m\]"
#   EMG="\[\033[1;32m\]"
#   EMY="\[\033[1;33m\]"
#   EMB="\[\033[1;34m\]"
#   EMM="\[\033[1;35m\]"
#   EMC="\[\033[1;36m\]"
#   EMW="\[\033[1;37m\]"
#   
#   # background colors
#   BGK="\[\033[40m\]"
#   BGR="\[\033[41m\]"
#   BGG="\[\033[42m\]"
#   BGY="\[\033[43m\]"
#   BGB="\[\033[44m\]"
#   BGM="\[\033[45m\]"
#   BGC="\[\033[46m\]"
#   BGW="\[\033[47m\]"

trap "exit 1" INT

. ~interch/etc/server-list.sh

date

echo 'server          role       #cpu  Mmem  procs    1m    5m   15m'

for i in $most_servers
do
	printf '%-16s' $i
	ssh -axqT -o BatchMode=yes -i /root/.ssh/id_dsa.bcs-push-robot-root $i '

#rodbcolor="\033[01;34m"
#appcolor="\033[01;32m"
#otherdbcolor="\033[01;35m"
#affilcolor="\033[01;30m"
#normcolor="\033[00m"

if grep -q rodb /etc/bc-role; then
	grep=postgres:
	color=$rodbcolor
elif grep -q app /etc/bc-role; then
	grep=cgi-bin
	color=$appcolor
elif grep -q db /etc/bc-role; then
	grep=postgres:
	color=$otherdbcolor
elif grep -q droid /etc/bc-role; then
	grep=droid
	color=$normcolor
elif grep -q affiliate /etc/bc-role; then
	grep="\\(postgres:\\|cgi-bin\\)"
	color=$affilcolor
elif grep -q mogilefs /etc/bc-role; then
	grep=mogilefsd
	color=$normcolor
else
	grep="\\(postgres:\\|cgi-bin\\)"
	color=$normcolor
fi

echo -ne $color

printf "%-10s" `cat /etc/bc-role`

cpu=`grep -c vendor_id /proc/cpuinfo`
printf " %4s" $cpu

mem=`free -m | grep Mem: | awk "{print \\$2}"`
printf " %5s" $mem

procs=`ps auxww | grep "$grep" | grep -c -v grep`
printf " %6s" $procs

echo -n "  "
load=`uptime | sed "s/.* load average:\( .*\)/\\1/"`
echo -n $load

echo -ne $normcolor
echo

'
done
