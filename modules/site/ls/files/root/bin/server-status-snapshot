#!/bin/sh

load=`uptime | perl -p -e 's/.*average: ([\d]+).*/$1/g'`

#echo Load $load

# Check if high load
if [ $load -lt 15 ]; then
   exit
fi


[ -z "$TMPDIR" ] && TMPDIR=/tmp
base="$TMPDIR/forensics/`date '+%Y%m%d/%H/%M/%S'`"
mkdir -p $base
cd $base || exit 1
ps -ewwo user,pid,ppid,pcpu,pmem,vsize,rss,tty4,stat,stime,time,command > ps
vmstat 1 2  > vmstat
iostat 1 2 > iostat
w > w
top -c -b -n 1 | head -n 40 > top
netstat --inet -n -a -p > netstat
dmesg | grep -vi treason > dmesg
ps auwwx | grep httpd | wc -l > httpd-count
