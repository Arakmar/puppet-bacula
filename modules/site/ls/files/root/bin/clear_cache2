#!/bin/bash

myhost=`hostname -s`
catalogs="bcs outlet dogfunk tramdock explore64 steepcheap wm chainlove"

echo "Starting to clear caches on $myhost"


echo "Clearing ODAT homepage cahces"
time rm -f /var/www/html/page_cache/steepcheap/sac.html /var/www/html/page_cache/wm/wm.html


for c in $catalogs
do
    echo "Clearing timed builds"
    time rm -rf /var/lib/interchange/$c/timed_build/*

    echo "Clearing Cacheable files"
    cacheables=`ls /var/lib/interchange/$c/tmp/file_cache_lockable/ | grep -v ^_ | grep -v '.junk'`
#    cacheables='index'
    for x in $cacheables
    do
        # Get the highest junk.(\d) number so we can increment it by one
        num=`ls /var/lib/interchange/$c/tmp/file_cache_lockable/ | grep "junk." | grep $x | sort -r | head -n 1 | perl -pi -e 's/[^0-9]//g'`
        if [ "$num" == "" ]; then
			num=0
        fi
        new_num=$(( $num + 1 ))

        echo "for /var/lib/interchange/$c/tmp/file_cache_lockable/$x, num=$num, new_num=$new_num"
        time mv /var/lib/interchange/$c/tmp/file_cache_lockable/$x /var/lib/interchange/$c/tmp/file_cache_lockable/$x.junk.$new_num
    done

done

echo "Done clearing cache for $myhost"
